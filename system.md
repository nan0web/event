---
test:
  engine: node:test
  format: describe > it()[]
jsdoc:
  locale: en-US
  target: functions, classes, properties
types:
  autogenerated: true
---
# üì¶ `@nan0web/event` ‚Äî –ê–≥–Ω–æ—Å—Ç–∏—á–Ω–∏–π, –ª–∞–∫–æ–Ω—ñ—á–Ω–∏–π, —Ä–æ–∑—à–∏—Ä—é–≤–∞–Ω–∏–π Event System

## üéØ –ú–µ—Ç–∞
–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–µ–≤–µ–ª–∏—á–∫–∏–π, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å—É–º—ñ—Å–Ω–∏–π —ñ –≥–Ω—É—á–∫–∏–π –µ–º—ñ—Ç–µ—Ä –ø–æ–¥—ñ–π, —è–∫–∏–π:
- –ü—Ä–∞—Ü—é—î –≤ Node.js, Browser, WebView, Deno
- –ü—ñ–¥—Ç—Ä–∏–º—É—î –æ–±–∏–¥–≤–∞ —Å—Ç–∏–ª—ñ: **—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π (light)** —Ç–∞ **OO–ü (extendable)**
- –ú–∞—î –ø—ñ–¥—Ç—Ä–∏–º–∫—É `preventDefault()` —ñ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ `emit`
- –ü—ñ–¥—Ç—Ä–∏–º—É—î tree-shaking
- –î–æ–∑–≤–æ–ª—è—î —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ command-–æ–±'—î–∫—Ç–∏ –∑ –ø–∞–π–ø–ª–∞–π–Ω–æ–º

---

## üß© –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–∫–µ—Ç—É

```
@nan0web/event
‚îú‚îÄ‚îÄ index.js              ‚Üí —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π API: `event()` factory
‚îú‚îÄ‚îÄ oop.js                ‚Üí –û–û–ü –±–∞–∑–∞: `class Event` –¥–ª—è —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è
‚îú‚îÄ‚îÄ command.js            ‚Üí —Ñ–∞–±—Ä–∏–∫–∞ `createCommand()` –¥–ª—è –ø–∞–π–ø–ª–∞–π–Ω-–∫–æ–º–∞–Ω–¥
‚îú‚îÄ‚îÄ adapters/
‚îÇ   ‚îú‚îÄ‚îÄ dom.js            ‚Üí –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î DOM CustomEvent
‚îÇ   ‚îî‚îÄ‚îÄ node.js           ‚Üí –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `node:events`
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ index.d.ts
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ README.md
```

---

## üîß –í–∞—Ä—ñ–∞–Ω—Ç 1: –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π (Light, Tree-shaking) ‚Äî `import event from "@nan0web/event"`

–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è **–º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏—Ö –∑–±—ñ—Ä–æ–∫**, **—à–≤–∏–¥–∫–∏—Ö —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ–π**, **–º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å—ñ–≤**, **–º–æ–¥—É–ª—å–Ω–∏—Ö —Å–∏—Å—Ç–µ–º**.

### ‚úÖ API

```js
import event from '@nan0web/event'

const bus = event() // –∞–±–æ event(window), event(document)

bus.on('tick', (data) => console.log(data))
bus.emit('tick', { value: 42 })

// –∑—É–ø–∏–Ω–∫–∞ –ø–æ–¥—ñ–π —á–µ—Ä–µ–∑ preventDefault() (–¥–∏–≤. async emit –Ω–∏–∂—á–µ)
```

### üîå –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è (index.js)

```js
// index.js
function isBrowser() {
  return typeof window !== 'undefined' && typeof window.document !== 'undefined'
}

function isNode() {
  return typeof process !== 'undefined' && process.versions?.node
}

export default function event(target) {
  if (target || isBrowser()) {
    return createDomAdapter(target || window)
  }
  if (isNode()) {
    return createNodeAdapter()
  }
  return createMemoryAdapter()
}

function createMemoryAdapter() {
  const listeners = new Map()

  return {
    on(event, fn) {
      const fns = listeners.get(event) || []
      fns.push(fn)
      listeners.set(event, fns)
    },
    off(event, fn) {
      const fns = listeners.get(event)
      if (fns) {
        listeners.set(event, fns.filter(f => f !== fn))
      }
    },
    async emit(event, data = {}) {
      const ctx = createEventContext(event, data)
      const fns = listeners.get(event) || []
      for (const fn of fns) {
        if (ctx.defaultPrevented) break
        await fn(ctx)
      }
      return ctx
    }
  }
}

function createEventContext(type, data) {
  return {
    type,
    data,
    defaultPrevented: false,
    preventDefault() {
      this.defaultPrevented = true
    }
  }
}
```

### üîÑ –ê–¥–∞–ø—Ç–µ—Ä–∏

```js
// adapters/dom.js
export function createDomAdapter(target) {
  const fnsMap = new WeakMap() // –æ—Ä–∏–≥—ñ–Ω–∞–ª ‚Üí –æ–±–≥–æ—Ä—Ç–∫–∞

  return {
    on(event, fn) {
      const wrapped = (e) => fn(createEventContext(event, e.detail))
      fnsMap.set(fn, wrapped)
      target.addEventListener(event, wrapped)
    },
    off(event, fn) {
      const wrapped = fnsMap.get(fn)
      if (wrapped) target.removeEventListener(event, wrapped)
    },
    async emit(event, data) {
      const ctx = createEventContext(event, data)
      target.dispatchEvent(new CustomEvent(event, { detail: data }))
      return ctx
    }
  }
}
```

```js
// adapters/node.js
import { EventEmitter } from 'node:events'

export function createNodeAdapter() {
  const emitter = new EventEmitter()
  const listeners = new Map()

  return {
    on(event, fn) {
      const wrapped = (data) => {
        const ctx = {
          type: event,
          data,
          defaultPrevented: false,
          preventDefault() { ctx.defaultPrevented = true }
        }
        fn(ctx)
      }
      listeners.set(fn, wrapped)
      emitter.on(event, wrapped)
    },
    off(event, fn) {
      const wrapped = listeners.get(fn)
      if (wrapped) {
        emitter.off(event, wrapped)
        listeners.delete(fn)
      }
    },
    async emit(event, data) {
      const ctx = createEventContext(event, data)
      emitter.emit(event, data)
      return ctx
    }
  }
}
```

---

## üß± –í–∞—Ä—ñ–∞–Ω—Ç 2: –û–û–ü (–†–æ–∑—à–∏—Ä—é–≤–∞–Ω–∏–π) ‚Äî `import Event from "@nan0web/event/oop"`

–î–æ–∑–≤–æ–ª—è—î **–Ω–∞—Å–ª—ñ–¥—É–≤–∞–Ω–Ω—è**, —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è **–≤–ª–∞—Å–Ω–∏—Ö –∫–ª–∞—Å—ñ–≤ —ñ–∑ –ø–æ–¥—ñ—è–º–∏**, **command pattern**, **–ø–∞–π–ø–ª–∞–π–Ω**.

### ‚úÖ –ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

```js
import Event from '@nan0web/event/oop'

class Command extends Event {
  constructor(name) {
    super()
    this.name = name
  }

  async execute(input) {
    const ctx = this.createContext('execute', input)

    this.emit('before', ctx)
    if (ctx.defaultPrevented) {
      this.emit('cancelled', ctx)
      return { ok: false, reason: 'cancelled' }
    }

    try {
      await this.action(ctx)
      this.emit('success', ctx)
      return { ok: true, data: ctx.data }
    } catch (err) {
      this.emit('error', { ...ctx, error: err })
      return { ok: false, error: err.message }
    }
  }

  async action(ctx) {
    throw new Error('Command.action() not implemented')
  }

  createContext(type, data) {
    const ctx = {
      type,
      data,
      defaultPrevented: false,
      preventDefault: () => { ctx.defaultPrevented = true }
    }
    return ctx
  }
}

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

class LoginCommand extends Command {
  constructor() {
    super('login')
  }

  async action(ctx) {
    if (!ctx.data.email) {
      ctx.preventDefault()
      throw new Error('Email required')
    }
    // —ñ–º—ñ—Ç–∞—Ü—ñ—è API-–∑–∞–ø–∏—Ç—É
    await new Promise(r => setTimeout(r, 100))
    console.log('Logged in:', ctx.data.email)
  }
}

// –ü—ñ–¥–ø–∏—Å–∫–∞

const login = new LoginCommand()

login.on('before', (ctx) => {
  if (ctx.data.dryRun) ctx.preventDefault()
})

login.on('success', (ctx) => {
  console.log('Success:', ctx.data.email)
})

await login.execute({ email: 'alice@nan0web.com' }) // ‚úÖ
await login.execute({ dryRun: true })               // ‚ùå, preventDefault()
```

### üîß –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è (oop.js)

```js
// oop.js
import event from './index.js'

export default class Event {
  constructor() {
    this.emitter = event() // –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π core
  }

  on(event, fn) {
    this.emitter.on(event, fn)
  }

  off(event, fn) {
    this.emitter.off(event, fn)
  }

  /**
   * –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–µ –≤–∏–ø—É—Å–∫–∞–Ω–Ω—è –ø–æ–¥—ñ—ó –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é preventDefault
   * @param {string} event
   * @param {any} data
   * @returns {Promise<{ defaultPrevented: boolean }>}
   */
  async emit(event, data) {
    return await this.emitter.emit(event, data)
  }
}
```

> –¢–∞–∫–∏–π –¥–∏–∑–∞–π–Ω –¥–∞—î:
> - –û–û–ü —ñ–Ω—Ñ–µ—Ä—Ñ–µ–π—Å —á–µ—Ä–µ–∑ —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π `event()`
> - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—É —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å —ñ–∑ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ–º
> - –ù–µ –≤–∏–Ω–æ—Å–∏—Ç—å –ª–æ–≥—ñ–∫—É –∞–¥–∞–ø—Ç–µ—Ä–∞ –≤ –∫–ª–∞—Å

---

## ‚öôÔ∏è `createCommand` ‚Äî factory –¥–ª—è command pipeline (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)

```js
// command.js
import event from './index.js'

export function createCommand(name, handler) {
  const bus = event()

  return {
    on: (type, fn) => bus.on(type, fn),
    off: (type, fn) => bus.off(type, fn),

    async execute(data) {
      const ctx = {
        name,
        data,
        defaultPrevented: false,
        preventDefault: () => { ctx.defaultPrevented = true },
        meta: {}
      }

      await bus.emit('before', ctx)
      if (ctx.defaultPrevented) return { ok: false, reason: 'cancelled' }

      try {
        await handler(ctx)
        await bus.emit('success', ctx)
        return { ok: true, data: ctx.data }
      } catch (err) {
        await bus.emit('error', { ...ctx, error: err })
        return { ok: false, error: err.message }
      }
    },

    bus
  }
}
```

–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:

```js
import { createCommand } from '@nan0web/event/command'

const notify = createCommand('notify', async (ctx) => {
  console.log('Sending email to:', ctx.data.email)
})

notify.on('success', () => console.log('Notified!'))
await notify.execute({ email: 'test@nan0web.com' })
```

---

## üß© TypeScript (types/index.d.ts)

```ts
/**
 * Event context with preventDefault support
 */
export interface EventContext<T = any> {
  type: string
  data: T
  defaultPrevented: boolean
  preventDefault(): void
}

/**
 * Listener function that receives event context
 */
export type EventListener<T = any> = (ctx: EventContext<T>) => void | Promise<void>

/**
 * Core event interface
 */
export interface EventBus {
  on(event: string, listener: EventListener): void
  off(event: string, listener: EventListener): void
  emit<T = any>(event: string, data?: T): Promise<EventContext<T>>
}

/**
 * Functional factory
 */
declare function nanEvent(target?: EventTarget | null): EventBus
export default nanEvent

/**
 * OO–ü base class
 */
declare class Event {
  protected emitter: EventBus

  on(event: string, listener: EventListener): void
  off(event: string, listener: EventListener): void
  emit<T = any>(event: string, data?: T): Promise<EventContext<T>>
}

declare module "@nan0web/event/oop" {
  export default Event
}

declare module "@nan0web/event/command" {
  export function createCommand(
    name: string,
    handler: (ctx: EventContext) => Promise<void> | void
  ): {
    on(event: string, fn: EventListener): void
    off(event: string, fn: EventListener): void
    execute(data: any): Promise<{ ok: boolean; data?: any; error?: string; reason?: string }>
  }
}
```

---

## üì¶ package.json ‚Äî tree-shaking i exports

```json
{
  "name": "@nan0web/event",
  "version": "1.0.0",
  "type": "module",
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./types/index.d.ts"
    },
    "./oop": {
      "import": "./dist/oop.js",
      "types": "./types/index.d.ts"
    },
    "./command": {
      "import": "./dist/command.js",
      "types": "./types/index.d.ts"
    },
    "./adapters/dom": {
      "import": "./dist/adapters/dom.js"
    },
    "./adapters/node": {
      "import": "./dist/adapters/node.js"
    }
  },
  "main": "./dist/index.js",
  "module": "./dist/index.js",
  "types": "./types/index.d.ts",
  "files": [
    "dist/",
    "types/"
  ],
  "scripts": {
    "build": "tsup",
    "test": "vitest"
  },
  "devDependencies": {
    "tsup": "^8.0.0",
    "vitest": "^1.0.0",
    "typescript": "^5.0.0"
  }
}
```

---

## ‚úÖ –ö–ª—é—á–æ–≤—ñ –ø–µ—Ä–µ–≤–∞–≥–∏

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞              | –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ? | –Ø–∫             |
|----------------------------|-------------|----------------|
| –ê–≥–Ω–æ—Å—Ç–∏—á–Ω—ñ—Å—Ç—å (Node/Browser)| ‚úÖ          | –ê–≤—Ç–æ–≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è |
| `preventDefault()`         | ‚úÖ          | –ß–µ—Ä–µ–∑ `ctx`    |
| –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π emit           | ‚úÖ          | `async emit`   |
| `extends Event`            | ‚úÖ          | –ß–µ—Ä–µ–∑ `/oop`   |
| Tree-shaking               | ‚úÖ          | `exports`     |
| Lightweight (< 1KB)        | ‚úÖ          | –õ–∞–∫–æ–Ω—ñ—á–Ω—ñ—Å—Ç—å  |
| –õ–µ–≥–∫–µ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è           | ‚úÖ          | `createCommand`, `adapters` |

---

## ‚úÖ –í–∏—Å–Ω–æ–≤–æ–∫

–¶–µ–π –¥–∏–∑–∞–π–Ω:
- –î–æ–∑–≤–æ–ª—è—î **–æ–±—Ä–∞–Ω–∏–π —Å—Ç–∏–ª—å**: —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π –∞–±–æ –û–û–ü
- **–ù–µ –¥—É–±–ª—é—î –ª–æ–≥—ñ–∫–∏**: `/oop` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ç–æ–π —Å–∞–º–∏–π `event()`
- –ú–∞—î **–ø–æ—Ç—É–∂–Ω–∏–π –ø–∞–π–ø–ª–∞–π–Ω** –¥–ª—è –∫–æ–º–∞–Ω–¥
- **–ü—ñ–¥—Ç—Ä–∏–º—É—î —É—Å—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞**
- **–Ü–¥–µ–∞–ª—å–Ω–∏–π –¥–ª—è –º–∏–∫—Ä–æ-—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—ñ–≤, –≤—ñ–¥–∂–µ—Ç—ñ–≤, –∫–æ–º–∞–Ω–¥, –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó –º—ñ–∂ –º–æ–¥—É–ª—è–º–∏**

---

–¶–µ–π –æ–ø–∏—Å –º–æ–∂–µ –±—É—Ç–∏ **–≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π —ñ–Ω—à–∏–º –∞–≥–µ–Ω—Ç–æ–º** –¥–ª—è:
- –ì–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Ñ–∞–π–ª—ñ–≤
- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±—ñ—Ä–∫–∏ (Tsup)
- –ù–∞–ø–∏—Å–∞–Ω–Ω—è —Ç–µ—Å—Ç—ñ–≤ (Vitest)
- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è CI/CD
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –∞–Ω–∞–ª—ñ–∑—É tree-shaking

---

–Ø–∫—â–æ –≤—ñ–Ω —Ç–µ–±–µ –≤–ª–∞—à—Ç–æ–≤—É—î ‚Äî –æ—Å—å –∫–æ–º–∞–Ω–¥–∞, —â–æ–± –∑—ñ–±—Ä–∞—Ç–∏ —Ü–µ –≤—Å–µ:

```bash
npm create tsup@latest @nan0web/event --template default,types
```

–ê–±–æ —è –º–æ–∂—É –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ **–ø–æ–≤–Ω–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π-—à–∞–±–ª–æ–Ω**, –∑ `src/`, `dist/`, `types/`, `vitest.config.ts`, `tsup.config.ts`, —ñ –∑—Ä–∞–∑–∫–∞–º–∏ —Ç–µ—Å—Ç—ñ–≤.

–•–æ—á–µ—à —Ç–∞–∫–∏–π **–±–æ—ñ–ª–µ—Ä–ø–ª–µ–π—Ç**?  
–Ø–∫—â–æ —Ç–∞–∫ ‚Äî –≤–∫–∞–∂–∏:
- –ß–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à `pnpm` —á–∏ `npm`?
- –ß–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ Deno?
- –ß–∏ —Ö–æ—á–µ—à —Å—Ö–µ–º—É —Ç–µ—Å—Ç—ñ–≤ –ø–æ –∫–æ–∂–Ω–æ–º—É –º–æ–¥—É–ª—é?

–Ø –π–æ–≥–æ –∑–≥–µ–Ω–µ—Ä—É—é –∑–∞ 1 —Ö–≤–∏–ª–∏–Ω—É üöÄ
